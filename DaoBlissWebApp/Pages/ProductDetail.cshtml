@page "{slug}"
@model DaoBlissWebApp.Pages.ProductDetailModel
@using DaoBlissWebApp.Common.Entities
@using System.Text.Json

@{ViewData["Title"] = "Chi tiết sản phẩm";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <div>
            <div class="relative">
                @{
                    var mainImage = Model.Product.Images.FirstOrDefault(i => i.IsMain == true)
                                    ?? Model.Product.Images.FirstOrDefault();
                }
                <img id="main-image" src="@mainImage?.ImageUrl"
                     alt="@mainImage?.AltText ?? Product.Name"
                     class="w-full h-96 object-cover rounded-xl" />
            </div>

            <div class="grid grid-cols-4 gap-3 mt-4">
                @foreach (var img in Model.Product.Images)
                {
                    <img src="@img.ImageUrl"
                         alt="@img.AltText ?? Product.Name"
                         class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity thumbnail-image" />
                }
            </div>
        </div>
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-4">@Model.Product.Name</h1>
            <div class="flex items-center space-x-4 mb-4">
                <div class="flex items-center space-x-1">
                    <i class="ri-star-fill text-yellow-400"></i>
                    <i class="ri-star-fill text-yellow-400"></i>
                    <i class="ri-star-fill text-yellow-400"></i>
                    <i class="ri-star-fill text-yellow-400"></i>
                    <i class="ri-star-fill text-yellow-400"></i>
                </div>
                <span class="text-sm text-gray-600">(0 đánh giá)</span>
            </div>
            <div class="text-3xl font-bold text-primary mb-6" id="product-price">
                @{
                    var firstVariant = Model.Product.Variants.FirstOrDefault();
                    string proPrice = firstVariant?.Price.ToString("c0", new System.Globalization.CultureInfo("vi-VN")) ?? "Liên hệ";
                }
                @proPrice
            </div>
            @{
                string desc = "";
                string uses = "";
                string ingredient = "";
                string cachdung = "";
                string warning = "";
                if (!string.IsNullOrEmpty(Model.Product.Description) && Model.Product.Description.TrimStart().StartsWith("{"))
                {
                    try
                    {
                        var parsed = JsonSerializer.Deserialize<ProductDescription>(Model.Product.Description);
                        desc = parsed?.Mota ?? "";
                        uses = parsed?.CongDung ?? "";
                        ingredient = parsed?.ThanhPhan ?? "";
                        cachdung = parsed?.CachSuDung ?? "";
                        warning = parsed?.LuuY ?? "";
                    }
                    catch
                    {
                        desc = Model.Product.Description;
                    }
                }
                else
                {
                    desc = Model.Product.Description;
                }
            }

            <p class="text-gray-700 mb-6 leading-relaxed">
                @desc
            </p>

            @if (Model.Product.Variants.Count > 1)
            {
                <div class="mb-6">
                    <span class="block text-gray-700 font-medium mb-2">Chọn kích cỡ:</span>
                    <div id="variant-options" class="flex space-x-3">
                        @foreach (var variant in Model.Product.Variants)
                        {
                            <button type="button"
                                    class="variant-option border border-gray-300 px-4 py-2 rounded hover:bg-gray-100 transition"
                                    data-variant-id="@variant.Id"
                                    data-variant-price="@variant.Price.ToString("c0", new System.Globalization.CultureInfo("vi-VN"))">
                                @variant.Size?.Name@variant.Size?.Unit
                            </button>
                        }
                    </div>
                </div>
            }
            else
            {
                <input type="hidden" id="selected-variant" value="@Model.Product.Variants.FirstOrDefault()?.Id" />
            }

            <div class="space-y-4 mb-8">
                <div class="flex items-center space-x-3">
                    <i class="ri-check-line text-primary text-lg"></i>
                    <span class="text-gray-700">100% thành phần tự nhiên từ thảo dược</span>
                </div>
                <div class="flex items-center space-x-3">
                    <i class="ri-check-line text-primary text-lg"></i>
                    <span class="text-gray-700">Không chứa phẩm màu nhân tạo</span>
                </div>
                <div class="flex items-center space-x-3">
                    <i class="ri-check-line text-primary text-lg"></i>
                    <span class="text-gray-700">Không chứa hóa chất độc hại</span>
                </div>
            </div>
            <div class="flex items-center space-x-4 mb-8">
                <span class="text-gray-700 font-medium">Số lượng:</span>
                <div class="flex items-center border border-gray-300 rounded">
                    <button id="decrease-qty" class="px-3 py-2 hover:bg-gray-100 transition-colors">
                        <i class="ri-subtract-line"></i>
                    </button>
                    <input id="quantity" type="number" value="1" min="1" max="5" class="w-16 text-center border-none outline-none">
                    <button id="increase-qty" class="px-3 py-2 hover:bg-gray-100 transition-colors">
                        <i class="ri-add-line"></i>
                    </button>
                </div>
            </div>
            <div class="flex space-x-4">
                <button id="add-to-cart" data-product-id="@Model.Product.Id" data-variant-id="@Model.Product.Variants.FirstOrDefault()?.Id"
                        class="flex-1 bg-white border-2 border-green-800 text-primary px-6 py-3 rounded !rounded-button font-semibold whitespace-nowrap hover:bg-green-700 hover:text-white transition-colors">
                    Thêm Vào Giỏ Hàng
                </button>
            </div>
        </div>
    </div>
</div>
<div class="max-w-7xl mx-auto px-6 py-12">
    <div class="border-b border-gray-200 mb-8">
        <nav class="flex space-x-8">
            <button class="tab-button py-4 px-1 border-b-2 border-primary text-primary font-medium" data-tab="description">
                Mô Tả Chi Tiết
            </button>
            <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="usage">
                Hướng Dẫn Sử Dụng
            </button>
            <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="reviews">
                Đánh Giá (0)
            </button>
        </nav>
    </div>
    <div id="description" class="tab-content">
        <div class="prose max-w-none">
            <h3 class="text-2xl font-bold text-gray-900 mb-6">Đặc Điểm Nổi Bật</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">Công Dụng Chính</h4>
                    @{
                        var steps = (uses ?? "").Split("\n", StringSplitOptions.RemoveEmptyEntries);
                        var index = 1;
                    }
                    <ul class="space-y-2 text-gray-700">
                        @foreach (var step in steps)
                        {
                            <li>• @step</li>
                        }
                    </ul>
                </div>
                <div class="">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">Thành Phần Tự Nhiên</h4>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="space-y-2 text-gray-700">
                            @ingredient
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="usage" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Cách Sử Dụng</h4>
                <div class="space-y-4">
                    <div>
                        @{
                            steps = (cachdung ?? "").Split("\n", StringSplitOptions.RemoveEmptyEntries);
                            index = 1;
                        }
                        <div class="space-y-4">
                            @foreach (var step in steps)
                            {
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold">
                                        @index
                                    </div>
                                    <div>
                                        <p class="text-gray-600 text-sm">@step</p>
                                    </div>
                                </div>
                                index++;
                            }
                        </div>
                    </div>

                </div>
            </div>
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Lời Khuyên</h4>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="space-y-2 text-gray-700">
                        @warning
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="reviews" class="tab-content hidden">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Đánh Giá Khách Hàng</h3>
            <button id="write-review" class="bg-primary text-white px-6 py-2 rounded !rounded-button font-semibold hover:bg-green-700 transition-colors">
                Viết Đánh Giá
            </button>
        </div>

        <div id="review-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-xl mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold text-gray-900">Viết Đánh Giá</h4>
                    <button id="close-review" class="text-gray-500 hover:text-gray-700">
                        <i class="ri-close-line text-2xl"></i>
                    </button>
                </div>

                <form method="post" asp-page-handler="Review" id="review-form" enctype="multipart/form-data">
                    <input type="hidden" name="Slug" value="@Model.Slug" />
                    <div class="mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-sm text-gray-700">Đánh giá của bạn:</span>
                            <div class="flex items-center" id="rating-stars">
                                <i class="ri-star-line text-xl text-gray-400 cursor-pointer hover:text-yellow-400 transition-colors rate-star" data-value="1"></i>
                                <i class="ri-star-line text-xl text-gray-400 cursor-pointer hover:text-yellow-400 transition-colors rate-star" data-value="2"></i>
                                <i class="ri-star-line text-xl text-gray-400 cursor-pointer hover:text-yellow-400 transition-colors rate-star" data-value="3"></i>
                                <i class="ri-star-line text-xl text-gray-400 cursor-pointer hover:text-yellow-400 transition-colors rate-star" data-value="4"></i>
                                <i class="ri-star-line text-xl text-gray-400 cursor-pointer hover:text-yellow-400 transition-colors rate-star" data-value="5"></i>
                            </div>
                            <input type="hidden" asp-for="ReviewInput.Rating" id="review-rating" value="0" />
                        </div>
                    </div>

                    <div class="mb-4">
                        <textarea id="review-content" name="ReviewInput.Comment"
                                  class="w-full h-32 px-4 py-2 border border-gray-200 rounded resize-none focus:outline-none focus:border-primary"
                                  placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm..."
                                  maxlength="500"></textarea>
                        <div class="text-right text-sm text-gray-500">
                            <span id="char-count">0</span>/500
                        </div>
                    </div>

                    @*<div class="mb-6">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="ri-image-line text-gray-600"></i>
                            <span class="text-sm text-gray-700">Thêm hình ảnh:</span>
                        </div>
                        <div class="flex flex-wrap gap-2" id="image-preview"></div>
                        <label class="block w-24 h-24 border-2 border-dashed border-gray-300 rounded cursor-pointer hover:border-primary transition-colors">
                            <input type="file" class="hidden" id="image-upload" name="images" accept="image/*" multiple>
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="ri-add-line text-2xl text-gray-400"></i>
                            </div>
                        </label>
                    </div>*@

                    <button type="submit" id="submit-review" class="w-full bg-primary text-white py-3 rounded !rounded-button font-semibold hover:bg-green-700 transition-colors">
                        Gửi Đánh Giá
                    </button>
                </form>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="bg-gray-50 rounded-lg p-6">
                <div class="text-center">
                    <div class="text-4xl font-bold text-primary mb-2">0.0</div>
                    <div class="flex items-center justify-center space-x-1 mb-2">
                        <i class="ri-star-fill text-yellow-400"></i>
                        <i class="ri-star-fill text-yellow-400"></i>
                        <i class="ri-star-fill text-yellow-400"></i>
                        <i class="ri-star-fill text-yellow-400"></i>
                        <i class="ri-star-fill text-yellow-400"></i>
                    </div>
                    <div class="text-sm text-gray-600">Dựa trên 0 đánh giá</div>
                </div>
            </div>
            <div class="lg:col-span-2 space-y-3">
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 w-12">5 sao</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <span class="text-sm text-gray-600 w-12">0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 w-12">4 sao</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <span class="text-sm text-gray-600 w-12">0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 w-12">3 sao</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-400 h-2 rounded-full" style="width:0%"></div>
                    </div>
                    <span class="text-sm text-gray-600 w-12">0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 w-12">2 sao</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <span class="text-sm text-gray-600 w-12">0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 w-12">1 sao</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <span class="text-sm text-gray-600 w-12">0</span>
                </div>
            </div>
        </div>
        <div class="space-y-6">
            @foreach (var review in Model.Product.Reviews.Where(r => r.IsApproved))
            {
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-start space-x-4">
                        <img src="https://readdy.ai/api/search-image?query=vietnamese%20woman%20portrait%20smiling%20natural%20beauty%20clean%20background%20professional%20headshot&width=60&height=60&seq=6&orientation=squarish"
                             alt="@review.User?.UserName" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h5 class="font-medium text-gray-900">@review.User?.UserName</h5>
                                <div class="flex items-center space-x-1">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="ri-star-fill text-yellow-400 text-sm" style="@(i <= review.Rating ? "" : "color: #d1d5db")"></i>
                                    }
                                </div>
                            </div>
                            <p class="text-gray-700 text-sm mb-2">@review.Comment</p>
                            <div class="text-xs text-gray-500">@review.CreatedAt.ToString("dd/MM/yyyy")</div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
  
</div>
<section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-6">
        <h2 class="text-3xl font-bold text-gray-900 text-center mb-12">Sản Phẩm Liên Quan</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            @for (int i = 0; i < 4; i++)
            {
                Product pro = Model.RelatedProducts[i];
                string imgUrl = pro.Images.FirstOrDefault()?.ImageUrl ?? "";
                string price = pro.Variants.FirstOrDefault()?.Price.ToString("c0", new System.Globalization.CultureInfo("vi-VN")) ?? "150.000 ₫";

                string desc2 = "";
                if (!string.IsNullOrEmpty(pro.Description) && pro.Description.TrimStart().StartsWith("{"))
                {
                    try
                    {
                        var parsed = JsonSerializer.Deserialize<ProductDescription>(pro.Description);
                        desc2 = parsed?.Mota ?? "";
                    }
                    catch
                    {
                        desc2 = pro.Description;
                    }
                }
                else
                {
                    desc2 = pro.Description;
                }
                <a asp-page="ProductDetail" asp-route-slug="@pro.Slug"
                   class="group block" data-readdy="true">
                    <div class="bg-white rounded-xl overflow-hidden shadow-lg transition-transform group-hover:-translate-y-1">
                        <img src="@imgUrl"
                             alt="@pro.Name" class="w-full h-64 object-cover object-top">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2 group-hover:text-primary">
                                @pro.Name
                            </h3>
                            <p class="text-gray-600 text-sm mb-4">
                                @desc2
                            </p>
                            <div class="flex items-center justify-between">
                                <span class="text-2xl font-bold text-primary">@price</span>
                            </div>
                        </div>
                    </div>
                </a>
            }
        </div>
    </div>
</section>

<script id="image-gallery">
    document.addEventListener('DOMContentLoaded', function () {
        const mainImage = document.getElementById('main-image');
        const thumbnails = document.querySelectorAll('.thumbnail-image');
        thumbnails.forEach(thumb => {
            thumb.addEventListener('click', function () {
                mainImage.src = thumb.src;
                mainImage.alt = thumb.alt;
            });
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const variantButtons = document.querySelectorAll(".variant-option");
        const addToCartBtn = document.getElementById("add-to-cart");
        const priceElement = document.getElementById("product-price");

        if (variantButtons.length > 0) {
            variantButtons[0].classList.add("bg-green-700", "text-white");

            variantButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    variantButtons.forEach(b => b.classList.remove("bg-green-700", "text-white"));
                    btn.classList.add("bg-green-700", "text-white");
                    const variantId = btn.getAttribute("data-variant-id");
                    addToCartBtn.setAttribute("data-variant-id", variantId);
                    const price = btn.getAttribute("data-variant-price");
                    priceElement.innerText = price;
                });
            });
        }
    });
</script>

<script id="quantity-controls">
    document.addEventListener('DOMContentLoaded', function () {
        const decreaseBtn = document.getElementById('decrease-qty');
        const increaseBtn = document.getElementById('increase-qty');
        const quantityInput = document.getElementById('quantity');

        quantityInput.addEventListener('input', function () {
            let value = parseInt(quantityInput.value);
            if (isNaN(value) || value < 1) {
                quantityInput.value = 1;
            } else if (value > 5) {
                quantityInput.value = 5;
            }
        });

        decreaseBtn.addEventListener('click', function () {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        });
        increaseBtn.addEventListener('click', function () {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue < 5) {
                quantityInput.value = currentValue + 1;
            } else {
                alert("Nếu bạn muốn mua hàng với số lượng lớn, xin vui lòng liên hệ hotline: 034 356 4378. Có mức chiết khấu thành cơ bản!");
            }

        });
    });
</script>
<script id="tab-navigation">
    document.addEventListener('DOMContentLoaded', function () {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const writeReviewBtn = document.getElementById('write-review');
        const reviewModal = document.getElementById('review-modal');
        const closeReviewBtn = document.getElementById('close-review');
        const submitReviewBtn = document.getElementById('submit-review');
        const ratingStars = document.querySelectorAll('#rating-stars i');
        const reviewContent = document.getElementById('review-content');
        const charCount = document.getElementById('char-count');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        let selectedRating = 0;

        tabButtons.forEach(button => {
            button.addEventListener('click', function () {
                const targetTab = this.getAttribute('data-tab');
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-primary', 'text-primary');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                this.classList.add('border-primary', 'text-primary');
                this.classList.remove('border-transparent', 'text-gray-500');
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(targetTab).classList.remove('hidden');
            });
        });

        writeReviewBtn.addEventListener('click', () => {
            if (!'@User.Identity?.IsAuthenticated'.toLowerCase() === 'true') {
                alert('Vui lòng đăng nhập để viết đánh giá!');
                return;
            }
            reviewModal.classList.remove('hidden');
            reviewModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        });

        closeReviewBtn.addEventListener('click', () => {
            reviewModal.classList.add('hidden');
            reviewModal.classList.remove('flex');
            document.body.style.overflow = '';
        });

        reviewModal.addEventListener('click', (e) => {
            if (e.target === reviewModal) {
                reviewModal.classList.add('hidden');
                reviewModal.classList.remove('flex');
                document.body.style.overflow = '';
            }
        });

        ratingStars.forEach((star, index) => {
            star.addEventListener('mouseover', () => {
                ratingStars.forEach((s, i) => {
                    if (i <= index) {
                        s.classList.remove('ri-star-line', 'text-gray-400');
                        s.classList.add('ri-star-fill', 'text-yellow-400');
                    } else {
                        s.classList.add('ri-star-line', 'text-gray-400');
                        s.classList.remove('ri-star-fill', 'text-yellow-400');
                    }
                });
            });

            star.addEventListener('click', () => {
                selectedRating = index + 1;
                document.getElementById("review-rating").value = selectedRating;
            });

            star.addEventListener('mouseleave', () => {
                ratingStars.forEach((s, i) => {
                    if (i < selectedRating) {
                        s.classList.remove('ri-star-line', 'text-gray-400');
                        s.classList.add('ri-star-fill', 'text-yellow-400');
                    } else {
                        s.classList.add('ri-star-line', 'text-gray-400');
                        s.classList.remove('ri-star-fill', 'text-yellow-400');
                    }
                });
            });
        });

        reviewContent.addEventListener('input', () => {
            charCount.textContent = reviewContent.value.length;
        });

        imageUpload.addEventListener('change', () => {
            const files = Array.from(imageUpload.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative w-24 h-24';
                    div.innerHTML = `
          <img src="${e.target.result}" class="w-full h-full object-cover rounded">
          <button class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
            <i class="ri-close-line"></i>
          </button>`;
                    div.querySelector('button').addEventListener('click', () => div.remove());
                    imagePreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });

        submitReviewBtn.addEventListener('click', () => {
            if (!selectedRating) {
                alert('Vui lòng chọn số sao đánh giá');
                return;
            }
            if (!reviewContent.value.trim()) {
                alert('Vui lòng nhập nội dung đánh giá');
                return;
            }

            reviewModal.classList.add('hidden');
            reviewModal.classList.remove('flex');
            document.body.style.overflow = '';

            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = 'Cảm ơn bạn đã đánh giá sản phẩm!';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });
    });
</script>
